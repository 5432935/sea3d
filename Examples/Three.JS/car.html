<!DOCTYPE html>
<html lang="en">
<head>
<title>Car</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
  * { margin:0; padding:0; border:0; pointer-events:none;}
  html { width:100%; height:100%; }
  body { background:#000; font:14px sans-serif; width:100%; height:100%; pointer-events:auto;}
  #threeCanvas{ position:absolute; top:0; left:0; display:block;}
  #logo{ pointer-events:none; position:absolute; left:0; bottom:0; width:300px; height:150px; }
</style>
<script src="js/three.min.js"></script>
<script src="js/loaders/sea3d.min.js"></script>
<script src="js/Detector.js"></script>
</head>
<body>
<canvas id="threeCanvas"></canvas>
<div id="output"></div>
<div id='logo'><object type="image/svg+xml" data="assets/sea3db.svg" id="logo"></object></div>
<script>
var seaModel = "assets/model/car.sea";
var worldSize = 0.1; 
var isBestQuality = true;
var fullLoaded = false;
var zoom = 1;
var ToRad = Math.PI / 180;

var camera, scene, renderer, center, cam, mouse;
var carMeshs = [];
var lights = [];
var key = [0,0,0,0,0];

window.onload = init;

function init(){
    var touchable = 'createTouch' in document;
    if(touchable){ isBestQuality = false; zoom=0.5;}
    else{ isBestQuality = true; zoom=1;}
    
     if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
    
    init3D();
}

function init3D(){

    cam = { horizontal:-40, vertical:75, distance:25 };
    mouse = { ox:0, oy:0, h:0, v:0, mx:0, my:0, dx:0, dy:0, down:false, over:false, moving:true };
    
    renderer = new THREE.WebGLRenderer({ canvas:threeCanvas, devicePixelRatio:zoom, precision: "mediump", antialias:isBestQuality });
    renderer.setSize( window.innerWidth, window.innerHeight, true );
    renderer.autoClear = false;
    
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera( 50, window.innerWidth/window.innerHeight, 0.5, 10000 );
    center = new THREE.Vector3(0,2,0);
    moveCamera();

    
    if(isBestQuality){      
        var d = 40;
        var hemiLight = new THREE.HemisphereLight( 0xfffffe, 0x4488ff, 0.5 );
        hemiLight.position.set( 0, 5, 0 ); 
        var light = new THREE.DirectionalLight( 0xfffffe, 1 );
        light.position.set( d/3, d, -d);
        light.target = new THREE.Object3D(0,5,0);
        light.shadowMapWidth = 1024;
        light.shadowMapHeight = 1024;
        light.shadowCameraLeft = -d;
        light.shadowCameraRight = d;
        light.shadowCameraTop = d;
        light.shadowCameraBottom = -d;
        light.shadowCameraFar = d*2;
        light.shadowCameraNear = d;
        light.shadowDarkness = 0.35;
        light.shadowBias =  -0.002;
        light.castShadow = true;
        //light.shadowCameraVisible = true;
        var lightPoint = new THREE.PointLight ( 0x4488ff, 0.5 );
        lightPoint.position.set( -d/3, -d/2, -d);
        var lightPoint2 = new THREE.PointLight ( 0xFFCC44, 0.5 );
        lightPoint2.position.set( -d/2, -d, -d);
    
        lights = [hemiLight, lightPoint, lightPoint2, light ];
    
        renderer.gammaInput = true;
        renderer.gammaOutput = true;
        renderer.shadowMapEnabled = true;

        var i = lights.length;
        while(i--){ scene.add( lights[i] );}
        output.innerHTML = "engine best";
    } else {
        output.innerHTML = "engine low";
    }

    // background
    var back = new THREE.Mesh( new THREE.IcosahedronGeometry(300,1), new THREE.MeshBasicMaterial( { map:gradTexture([[0.75,0.5,0.45, 0.2], ['#2e3032','#4e5052','#69757e', '#86a4bc']]), side:THREE.BackSide, depthWrite: false }  ));
    back.geometry.applyMatrix(new THREE.Matrix4().makeRotationZ(5*ToRad));
    scene.add( back );

    // ground
    var mesh = new THREE.Mesh( new THREE.PlaneGeometry( 400, 400, 1, 1 ), new THREE.MeshBasicMaterial( { color: 0xFFFFFF, transparent: true, blending:THREE[ "MultiplyBlending" ] } ) );
    mesh.castShadow = false;
    mesh.receiveShadow = true;
    mesh.rotation.x = -90 * ToRad;
    scene.add( mesh );
    
    window.addEventListener( 'resize', resize, false );

    var body = document.body;
    body.addEventListener( 'mousemove', onMouseMove, false );
    body.addEventListener( 'mousedown', onMouseDown, false );
    body.addEventListener( 'mouseup', onMouseUp, false );
    body.addEventListener( 'mouseout', onMouseUp, false );
    
    body.addEventListener( 'touchstart', onMouseDown, false );
    body.addEventListener( 'touchend', onMouseUp, false );
    body.addEventListener( 'touchmove', onMouseMove, false );
    
    if( body.addEventListener ){
        body.addEventListener( 'mousewheel', onMouseWheel, false ); //chrome
        body.addEventListener( 'DOMMouseScroll', onMouseWheel, false ); // firefox
    }else if( body.attachEvent ){
        body.attachEvent("onmousewheel" , onMouseWheel); // ie
    }
    
    loop();
    //

    loadSea3d();
}

function loop() {
    requestAnimationFrame( loop, renderer.domElement );
    renderer.render( scene, camera );
}

function resize() {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight, true);
}

function loadSea3d(){
    var loader = new THREE.SEA3D( true );
    loader.onComplete = function( e ) {
        var m;
        var i = loader.meshes.length;
        while(i--){
            m = loader.meshes[i];
            if(m.name == 'glass') m.material.transparent = true;
            if(m.name == 'body'){ scene.add( m ); m.scale.set(worldSize,worldSize, -worldSize); m.position.y = 16*worldSize; }//}
        }
    }
    loader.load( seaModel );
}

function scaleGeometry(g, s){
    var mtx = new THREE.Matrix4().makeScale(s, s, -s);
    g.applyMatrix(mtx);
    g.computeFaceNormals();
    g.computeVertexNormals();
}

function Orbit(origine, horizontal, vertical, distance) {
    var p = new THREE.Vector3();
    var phi = vertical*ToRad;
    var theta = horizontal*ToRad;
    p.x = (distance * Math.sin(phi) * Math.cos(theta)) + origine.x;
    p.z = (distance * Math.sin(phi) * Math.sin(theta)) + origine.z;
    p.y = (distance * Math.cos(phi)) + origine.y;
    return p;
}

function moveCamera() {
    camera.position.copy(Orbit(center, cam.horizontal, cam.vertical, cam.distance));
    camera.lookAt(center);
}

function onMouseDown(e) {
    e.preventDefault();
    var px, py;
    if(e.touches){
        px = e.clientX || e.touches[ 0 ].pageX;
        py = e.clientY || e.touches[ 0 ].pageY;
    } else {
        px = e.clientX;
        py = e.clientY;
    }
    mouse.ox = px;
    mouse.oy = py;
    mouse.h = cam.horizontal;
    mouse.v = cam.vertical;
    mouse.down = true;
}

function onMouseUp(e) {
    mouse.down = false;
    document.body.style.cursor = 'auto';
}

function onMouseMove(e) {
    e.preventDefault();
    var px, py;
    if(e.touches){
        px = e.clientX || e.touches[ 0 ].pageX;
        py = e.clientY || e.touches[ 0 ].pageY;
    } else {
        px = e.clientX;
        py = e.clientY;
    }
    
    if (mouse.down) {      
        document.body.style.cursor = 'move';
        cam.horizontal = ((px - mouse.ox) * 0.3) + mouse.h;
        cam.vertical = (-(py - mouse.oy) * 0.3) + mouse.v;
        moveCamera();
    }
}

function onMouseWheel(e) {
    e.preventDefault();
    var delta = 0;
    if(e.wheelDelta){delta=e.wheelDelta*-1;}
    else if(e.detail){delta=e.detail*20;}
    cam.distance+=(delta/80);
    if(cam.distance<0.01)cam.distance = 0.01;
    if(cam.distance>150)cam.distance = 150;
    moveCamera(); 
}

function bindKeys() {
    document.onkeydown = function(e) {
        e = e || window.event;
        switch ( e.keyCode ) {
            case 38: case 87: case 90: key[0] = 1; break; // up, W, Z
            case 40: case 83: key[1] = 1; break;          // down, S
            case 37: case 65: case 81: key[2] = 1; break; // left, A, Q
            case 39: case 68: key[3] = 1; break;          // right, D
            case 17: case 67: key[4] = 1; break;          // ctrl, c
            case 32: key[5] = 1; break;                   // space
        }
    }
    document.onkeyup = function(e) {
        e = e || window.event
        switch( e.keyCode ) {
            case 38: case 87: case 90: key[0] = 0; break; // up, W, Z
            case 40: case 83: key[1] = 0; break;          // down, S
            case 37: case 65: case 81: key[2] = 0; break; // left, A, Q
            case 39: case 68: key[3] = 0; break;          // right, D
            case 17: case 67: key[4] = 0; break;          // ctrl, c
            case 32: key[5] = 0; break;                   // space
        }
    }
    self.focus();
}

function gradTexture(color) {
    var c = document.createElement("canvas");
    var ct = c.getContext("2d");
    c.width = 16; c.height = 256;
    var gradient = ct.createLinearGradient(0,0,0,256);
    var i = color[0].length;
    while(i--){ gradient.addColorStop(color[0][i],color[1][i]); }
    ct.fillStyle = gradient;
    ct.fillRect(0,0,16,256);
    var texture = new THREE.Texture(c);
    texture.needsUpdate = true;
    return texture;
}

</script>
</body>
</html>